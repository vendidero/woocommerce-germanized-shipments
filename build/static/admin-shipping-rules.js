!function(e,i,n,t){e((function(){var t=e(".wc-gzd-shipments-shipping-rules-rows"),s=e(".wc-gzd-shipments-shipping-rules"),r=n.template("wc-gzd-shipments-shipping-rules-row"),o=n.template("wc-gzd-shipments-shipping-rules-condition-row"),a=n.template("wc-gzd-shipments-shipping-rules-packaging-info"),d={},c=Backbone.Model.extend({updateRules:function(e,i){0===Object.keys(e).length&&(e={});var n={...this.get("rules")};n[String(i)]=e,this.set("rules",n)},updateConditions:function(e,i,n){0===Object.keys(e).length&&(e={});const t="rule_"===String(n).substring(0,5)?n:"rule_"+String(n),s={...this.getRule(i,n)};var r={...this.get("rules")};s.conditions=e,r[String(i)][t]=s,this.set("rules",r)},getRulesByPackaging:function(e){var i={...this.get("rules")};return i.hasOwnProperty(String(e))?i[String(e)]:{}},getRule:function(e,i){const n=this.getRulesByPackaging(e),t="rule_"===String(i).substring(0,5)?i:"rule_"+String(i);return n.hasOwnProperty(t)?n[t]:{}},getConditionsByRuleId:function(e,i){const n=this.getRule(e,i);return n.hasOwnProperty("conditions")?n.conditions:{}}}),l=Backbone.View.extend({rowTemplate:r,conditionViews:{},packaging:"",initialize:function(){this.packaging=String(e(this.el).data("packaging")),this.conditionViews={},e(this.el).on("change",{view:this},this.updateModelOnChange)},block:function(){e(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){e(this.el).unblock()},getRules:function(){return this.model.getRulesByPackaging(this.packaging)},render:function(){var i=this.getRules(),n=this;this.$el.empty(),this.unblock(),_.size(i)&&e.each(i,(function(e,i){n.renderRow(i)}))},renderRow:function(e){var i=this;i.$el.append(i.rowTemplate(e));var n=i.$el.find('tr[data-id="'+e.rule_id+'"]'),t=new u({model:i.model,el:n.find(".wc-gzd-shipments-shipping-rules-condition-rows")[0]});t.ruleId=e.rule_id,t.packaging=i.packaging,t.parentView=i,t.render(),i.initRow(e)},initFields:function(i,n){e(document.body).trigger("wc-enhanced-select-init"),i.find("select").each((function(){var i=e(this).data("attribute");if(n[i]){var t=Array.isArray(n[i])?n[i]:Array(String(n[i])),s=e(this);e.each(t,(function(e,i){$isSelected=s.find('option[value="'+String(i)+'"]'),$isSelected.length>0&&$isSelected.prop("selected",!0)})),s.hasClass("enhanced")&&s.trigger("change")}})),i.find("input.decimal").on("change",{view:this},this.onChangeDecimal),i.find("input.wc_input_price").on("change",{view:this},this.onChangePrice),i.find("input.decimal, input.wc_input_price").trigger("change")},initRow:function(i){var n=this.$el.find('tr[data-id="'+i.rule_id+'"]'),t=n.parents("tbody");if(this.initFields(n,i),n.find(".shipping-rule-remove").on("click",{view:this},this.onDeleteRow),n.find(".shipping-rule-add").on("click",{view:this},this.onAddRow),t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info").length<=0){t.prepend(a);var s=t.find("tr.wc-gzd-shipments-shipping-rules-packaging-info");s.find(".packaging-title").html(t.data("title")),t.data("help-tip")?s.find(".woocommerce-help-tip").attr("data-tip",t.data("help-tip")):s.find(".woocommerce-help-tip").remove(),t.data("edit-url")&&s.find(".packaging-title").attr("href",t.data("edit-url"))}e(document.body).trigger("init_tooltips")},onChangeDecimal:function(n){e(this).closest("tr");var t=e(this);t.val(t.val().replace(".",i.decimal_separator))},onChangePrice:function(n){e(this).closest("tr");var t=e(this);t.val(t.val().replace(".",i.price_decimal_separator))},onDeleteRow:function(i){var n=i.data.view,t=n.model,s=n.getRules(),r="rule_"+e(this).closest("tr").data("id");return s[r]&&(delete s[r],t.updateRules(s,n.packaging)),n.render(),n.$el.find("tr.shipping-rule:last").length>0&&n.$el.find("tr.shipping-rule:last").addClass("current"),!1},onAddRow:function(i){var n=i.data.view,t=n.model,s=n.getRules(),r=s["rule_"+e(this).closest("tr").data("id")],o=_.extend({},r,{rule_id:"new-"+_.size(s)+"-"+Date.now(),newRow:!0,conditions:{},costs:""}),a=0;return e.each(r.conditions,(function(e,i){var n="new-c-"+Date.now()+a;o.conditions["condition_"+n]=_.extend({},i,{condition_id:n,rule_id:o.rule_id,newRow:!0}),a++})),s["rule_"+o.rule_id]=o,t.updateRules(s,n.packaging),n.renderRow(o),n.$el.find('tr[data-id="'+o.rule_id+'"]').trigger("focus"),!1},updateModelOnChange:function(n){var t=n.data.view,s=t.model,r=e(n.target),o="rule_"+r.closest("tr").data("id"),a=r.data("attribute"),c=r.val(),l=t.getRules();if(r.parents(".wc-gzd-shipments-shipping-rules-condition-rows").length>0)return!1;if(!r.is(":visible"))return!1;if(r.is(":checkbox")?c=r.is(":checked")?c:"":c&&r.hasClass("decimal")?c=parseFloat(c.replace(i.decimal_separator,".")):c&&r.hasClass("wc_input_price")&&(c=parseFloat(c.replace(i.price_decimal_separator,"."))),!l[o]||String(l[o][a])!==String(c))if(l[o][a]=c,String(l[o].packaging)!==String(t.packaging)){var p=l[o].packaging,u=d[p],g=u.getRules();g[o]={...l[o]},delete l[o],s.updateRules(l,t.packaging),u.model.updateRules(g,p),t.render(),u.render()}else s.updateRules(l,t.packaging)}}),p=new c({rules:i.rules}),u=l.extend({rowTemplate:o,ruleId:0,packaging:"",parentView:!1,initialize:function(){e(this.el).on("change",{view:this},this.updateModelOnChange)},getRules:function(){return this.model.getConditionsByRuleId(this.packaging,this.ruleId)},render:function(){var i=this.getRules(),n=this;this.$el.empty(),_.size(i)&&e.each(i,(function(e,i){n.renderRow(i)}))},renderRow:function(e){var i=this;i.$el.append(i.rowTemplate(e)),i.initRow(e)},initRow:function(i){var n=this.$el.find('tr[data-condition="'+i.condition_id+'"]');n.parents("tbody"),this.initFields(n,i),0===n.index()&&n.find(".condition-remove").hide(),n.find(".shipping-rules-type-container").hide(),n.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),n.find(".shipping-rules-condition-type").on("change",{view:this},this.onChangeRuleType),n.find(".shipping-rules-condition-type").trigger("change"),n.find(".condition-remove").on("click",{view:this},this.onDeleteRow),n.find(".condition-add").on("click",{view:this},this.onAddRow),e(document.body).trigger("init_tooltips")},onChangeRuleType:function(i){var n=e(this).closest("tr"),t=e(this).val(),s=i.data.view;n.find(".shipping-rules-condition-type-container").hide(),n.find(".conditions-column:not(.conditions-when,.conditions-actions)").hide(),n.find(".shipping-rules-condition-type-container-"+t).show(),n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").length>0?n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").trigger("change"):s.updateModel(n.data("condition"),"operator",""),n.find(".shipping-rules-condition-type-container-"+t+".shipping-rule-condition-type-operator :input").trigger("change"),n.find(".shipping-rules-condition-type-container-"+t).parents(".conditions-column").show()},updateModel:function(e,i,n){var t=this.model,s="condition_"+e,r=this.getRules();r[s]&&String(r[s][i])===String(n)||(r[s][i]=n,t.updateConditions(r,this.packaging,this.ruleId))},updateModelOnChange:function(n){var t=n.data.view,s=e(n.target),r=s.closest("tr").data("condition"),o=s.data("attribute"),a=s.val();if(!s.is(":visible"))return!1;s.is(":checkbox")?a=s.is(":checked")?a:"":a&&s.hasClass("decimal")?a=parseFloat(a.replace(i.decimal_separator,".")):a&&s.hasClass("wc_input_price")&&(a=parseFloat(a.replace(i.price_decimal_separator,"."))),t.updateModel(r,o,a)},onDeleteRow:function(i){var n=i.data.view,t=n.model,s=n.getRules(),r=e(this).closest("tr"),o="condition_"+r.data("condition");return s[o]&&0!==r.index()&&(delete s[o],t.updateConditions(s,n.packaging,n.ruleId)),n.render(),!1},onAddRow:function(i){var n=i.data.view,t=n.model,s=n.getRules(),r=s["condition_"+e(this).closest("tr").data("condition")],o=_.extend({},r,{condition_id:"new-c-"+_.size(s)+"-"+Date.now(),newRow:!0,costs:""});return-1!==e.inArray(o.type,["weight","total"])&&(o[o.type+"_from"]=o[o.type+"_to"],o[o.type+"_to"]=""),s["condition_"+o.condition_id]=o,t.updateConditions(s,n.packaging,n.ruleId),n.renderRow(o),!1}});t.each((function(){var i=new l({model:p,el:e(this)});i.render(),d[e(this).data("packaging")]=i,e(this).sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,helper:function(i,n){return n.children().each((function(){e(this).width(e(this).width())})),n.css("left","0"),n},start:function(e,i){i.item.css("background-color","#f6f6f6")},stop:function(e,i){i.item.removeAttr("style"),i.item.trigger("updateMoveButtons"),i.item.trigger("focus")}})})),e(document).on("change",".wc-gzd-shipments-shipping-rules-cb-all",(function(){var i=e(this).parents("table");e(this).is(":checked")?i.find("input.cb").prop("checked",!0):i.find("input.cb").prop("checked",!1)})),e(document).on("click",".wc-gzd-shipments-shipping-rule-add",(function(){var n=e(".new-shipping-packaging").val(),t=d[n],s=t.model.getRulesByPackaging(n),r=_.extend({},i.default_shipping_rule,{rule_id:"new-"+_.size(s)+"-"+Date.now(),packaging:n,newRow:!0}),o="new-c-"+Date.now(),a=r.conditions[0];return r.conditions={},r.conditions["condition_"+o]=_.extend({},a,{condition_id:o,rule_id:r.rule_id,newRow:!0}),s["rule_"+r.rule_id]=r,t.model.updateRules(s,n),d[n].renderRow(r),d[n].$el.find('tr[data-id="'+r.rule_id+'"]').trigger("focus"),!1})),e(document).on("click",".wc-gzd-shipments-shipping-rule-remove",(function(){var i=p.get("rules"),n=e(this),t=n.parents("table"),s=[];return t.find("input.cb:checked").each((function(){var n="rule_"+e(this).val(),t=e(this).parents("tr").find(".shipping-packaging").val();s.includes(t)||s.push(t),delete i[t][n]})),p.set("rules",i),s.forEach((function(e,i){d[e].render()})),n.addClass("disabled"),t.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!1),!1})),e(document).on("keydown",(function(i){var n=s.find("tr.current"),t=e(".wc-gzd-shipments-shipping-rules.has-focus");if(0!==n.length||0!==t.length){var r=i.metaKey||i.ctrlKey;return!r||"d"!==i.key&&"-"!==i.key?n&&r&&"+"===i.key?(n.find(".shipping-rule-add").trigger("click"),i.preventDefault(),i.stopPropagation(),!1):t&&r&&"a"===i.key?(t.find(".wc-gzd-shipments-shipping-rules-cb-all").prop("checked",!t.find(".wc-gzd-shipments-shipping-rules-cb-all").is(":checked")),t.find(".wc-gzd-shipments-shipping-rules-cb-all").trigger("change"),i.preventDefault(),i.stopPropagation(),!1):void 0:($selected=s.find("input.cb:checked"),$selected.length>0?s.find(".wc-gzd-shipments-shipping-rule-remove").trigger("click"):n&&n.find(".shipping-rule-remove").trigger("click"),i.preventDefault(),i.stopPropagation(),!1)}})),e(document).on("change",".wc-gzd-shipments-shipping-rules-rows input.cb, .wc-gzd-shipments-shipping-rules-cb-all",(function(){$selected=e(this).parents("table").find("input.cb:checked"),$selected.length>0?s.find(".wc-gzd-shipments-shipping-rule-remove").removeClass("disabled"):s.find(".wc-gzd-shipments-shipping-rule-remove").addClass("disabled")})),e(document).on("mouseup",(function(i){var n=e("table.wc-gzd-shipments-shipping-rules");n.is(i.target)||0!==n.has(i.target).length?n.addClass("has-focus"):(n.removeClass("has-focus"),n.find("tr").removeClass("current"))})),e(document).on("click",".wc-gzd-shipments-shipping-rules tbody, .wc-gzd-shipments-shipping-rules input",(function(){e(this).trigger("focus")})),e(document).on("focus click",".wc-gzd-shipments-shipping-rules input, .wc-gzd-shipments-shipping-rules tr",(function(i){e(this).parents("table").find("tr").removeClass("current"),e(this).closest("tr.shipping-rule").addClass("current")}))}))}(jQuery,wc_gzd_shipments_admin_shipping_rules_params,wp,ajaxurl),((window.wcGzdShipments=window.wcGzdShipments||{}).static=window.wcGzdShipments.static||{})["admin-shipping-rules"]={};